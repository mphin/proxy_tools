name: Plugin_update

on:
  workflow_dispatch:
  schedule:
    - cron: "0 20 * * *"
  push:
    branches:
      - main
    paths:
      - 'scripts/**'
      - 'loon/plugin/**'
jobs:
  Plugin_update:
    runs-on: ubuntu-latest

    steps:
    - name: Set up time zone
      run: sudo timedatectl set-timezone Asia/Shanghai

    - name: Checkout repository
      uses: actions/checkout@main
      
    - name: Get last commit files
      if: github.event_name == 'push'
      id: last_commit
      run: |
         echo "sha=$(git rev-parse HEAD)" >> $GITHUB_ENV

    - name: Get changed files
      if: github.event_name == 'push'
      id: file_conf
      run: |
        COMMIT=${{ env.sha }}
        URL="https://api.github.com/repos/${{ github.repository }}/compare/${COMMIT}^...${COMMIT}"
        conf_File=$(curl -s -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" $URL | jq -r '.files[] | select(.filename | test("^scripts/.*\\.conf$")) | .filename' | tr '\n' ' ')
        echo "conf_File=${conf_File}" >> $GITHUB_OUTPUT
          
    - name: Update Plugin
      run: |
        script_folder="scripts" #å­˜æ”¾é…ç½®å’Œè„šæœ¬ç›®å½•
        loon_plugin_folder="loon/plugin" #å­˜æ”¾ç”ŸæˆLoonæ’ä»¶ç›®å½•
        base_url="https://raw.githubusercontent.com/$GITHUB_REPOSITORY/${GITHUB_REF##*/}/"
        current_year=$(date +'%Y')
        current_date=$(date "+%Y-%m-%d %H:%M:%S")
        previous_year_1=$((current_year - 1))
        previous_year_2=$((current_year - 2))
        echo 'user_agent = "Loon/699 CFNetwork/1496.0.7 Darwin/23.5.0"' >> ~/.wgetrc
        mkdir -p "$script_folder" "$script_folder" "$loon_plugin_folder" tmp
        
        extract_value() {
            grep -i "$1" "$2" | awk -F '=' '{print $2}' | sed 's/^[[:space:]]*//; s/[[:space:]]*$//; s/%0D//'
        }
        
        if [ "${{ github.event_name }}" = "workflow_dispatch" ] || [ "${{ github.event_name }}" = "schedule" ]; then
            conf_File=($(find "$script_folder" -name '*.conf'))
        else
            conf_File="${{ steps.file_conf.outputs.conf_File }}" && IFS=' ' read -r -a conf_File <<< "$conf_File"
            [ ${#conf_File[@]} -eq 0 ] && conf_File=($(find "$script_folder" -name '*.conf'))
        fi
        for conf_file in "${conf_File[@]}"; do
            if [ -e "$conf_file" ]; then
                remote_url=$(extract_value "^remote_url" $conf_file)
                script_name=$(extract_value "^script_name" $conf_file)
                [ -z "$script_name" ] && script_name=$(basename "$remote_url" | sed 's/\.[^.]*$//' | awk '{print tolower($0)}')
                if [[ $remote_url == http* ]]; then
                    download_file="$script_folder/$script_name/files/$(basename "$remote_url" | awk '{print tolower($0)}')"
                    mkdir -p "$script_folder/$script_name/files/" && wget -O "$download_file" "$remote_url" --tries=2
                
                    name=$(extract_value "^#!name" $conf_file)
                    [ -z "$name" ] && name=$(extract_value "^#!name" $download_file)
                    [ -z "$name" ] && name=$script_name
                
                    desc=$(extract_value "^#!desc" $conf_file)
                    [ -z "$desc" ] && desc=$(extract_value "^#!desc" $download_file)
                    [ -z "$desc" ] && desc="ä»…ä¾›å­¦ä¹ å’Œä¸ªäººä½¿ç”¨ï¼Œä¸å¾—ç”¨äºå•†ä¸šç›®çš„æˆ–å…¶ä»–éæ³•ç”¨é€”"
                
                    openurl=$(extract_value "^#!openUrl" $conf_file)
                    [ -z "$openurl" ] && openurl=$(extract_value "^#!openUrl" $download_file)
                
                    author=$(extract_value "^#!author" "$conf_file")
                    [ -z "$author" ] && author=$(extract_value "^#!author" "$download_file")
                
                    homepage=$(extract_value "^#!homepage" $conf_file)
                    [ -z "$homepage" ] && homepage=$(extract_value "^#!homepage" $download_file)
                
                    icon=$(extract_value "^#!icon" $conf_file)
                    [ -z "$icon" ] && icon=$(extract_value "^#!icon" $download_file)
                
                    select=$(extract_value "^#!select" $conf_file)
                    [ -z "$select" ] && select=$(extract_value "^#!select" $download_file)
                
                    input=$(extract_value "^#!input" $conf_file)
                    [ -z "$input" ] && input=$(extract_value "^#!input" $download_file)
                
                    date=$(extract_value "^#!date" $conf_file)
                    [ -z "$date" ] && date=$(awk '/\/\*/,/\*\// || /#/' "$download_file" | grep -oEm 1 "$current_year[-/å¹´.][[:digit:]]{1,2}[-/å¹´.][[:digit:]]{1,2}|$previous_year_1[-/å¹´.][[:digit:]]{1,2}[-/å¹´.][[:digit:]]{1,2}|$previous_year_2[-/å¹´.][[:digit:]]{1,2}[-/å¹´.][[:digit:]]{1,2}" || extract_value "^#!date" $download_file)
                    [ -z "$date" ] && { date="$current_date"; grep -q '^#!date' "$conf_file" && sed -i "s/^#!date.*/#!date = $current_date/" "$conf_file" || echo -e "\n#!date = $current_date" >> "$conf_file"; }
                    date=$(echo "$date" | sed 's/[\/å¹´.]/-/g; /[0-9]\{4\}-[0-9]\{2\}-[0-9]\{2\} [0-9]\{2\}:[0-9]\{2\}:[0-9]\{2\}/! s/$/ 00:00:00/')
                    
                    mkdir -p "tmp/$loon_plugin_folder/"
                    plugin_file="tmp/$loon_plugin_folder/$script_name.plugin"
                    [[ "$remote_url" == *.plugin ]] && echo -e "/*\næ’ä»¶å¼•ç”¨"$remote_url"\n*/" > "$plugin_file"
                    echo "#!name = $name" >> "$plugin_file"
                    echo "#!desc = $desc" >> "$plugin_file"
                    [ -n "$openurl" ] && echo "#!openUrl = $openurl" >> "$plugin_file"
                    [ -n "$author" ] && echo "#!author = $author" >> "$plugin_file"
                    [ -n "$homepage" ] && echo "#!homepage = $homepage" >> "$plugin_file"
                    if [ -n "$icon" ]; then
                        icon_file="$script_folder/$script_name/icon/$script_name.png"
                        [ ! -e "$icon_file" ] && mkdir -p "$script_folder/$script_name/icon" && wget -O "$icon_file" "$icon" --tries=2
                        echo "#!icon = $base_url$icon_file" >> "$plugin_file"
                    fi
                    [ -n "$select" ] && echo "$select" | sed 's/^/#!select = /' >> "$plugin_file"
                    [ -n "$input" ] && echo "$input" | sed 's/^/#!input = /' >> "$plugin_file"
                    echo "#!date = $date" >> "$plugin_file"

                    mitm=$(grep -i "^hostname" $conf_file | awk -F '=' '{print $2}' | sed 's/^[[:space:]]*//; s/[[:space:]]*$//; s/%0D//; s/,$//; s/,\([^ ]\)/, \1/g')
                    [ -z "$mitm" ] &&mitm=$(grep -i "^hostname" $download_file | awk -F '=' '{print $2}' | sed 's/^[[:space:]]*//; s/[[:space:]]*$//; s/%0D//; s/,$//; s/,\([^ ]\)/, \1/g' | sed 's/%INSERT% //; s/%APPEND% //')
                    script=$(sed -n '/\[Script\]/,/^\[/p' "$conf_file" | sed '/^\[/d; /^[[:space:]]*$/d')
                    [ -z "$script" ] && script=$(sed -n '/\[Script\]/,/^\[/p;/\[rewrite_local\]/,/^\[/p' "$download_file" | sed '/^\[/d; /^[[:space:]]*$/d')
                    rewrite=$(sed -n '/\[Rewrite\]/,/^\[/p' "$conf_file" | sed '/^\[/d; /^[[:space:]]*$/d; /^#/d')
                    [ -z "$rewrite" ] && rewrite=$(sed -n '/\[.*Rewrite\]/,/^\[/p' "$download_file" | sed '/^\[/d; /^[[:space:]]*$/d; /^#/d')
                    general=$(sed -n '/\[General\]/,/^\[/p' "$conf_file" | sed '/^\[/d; /^[[:space:]]*$/d; /^#/d')
                    [ -z "$general" ] && general=$(sed -n '/\[General\]/,/^\[/p' "$download_file" | sed '/^\[/d; /^[[:space:]]*$/d; /^#/d' | sed '/always-raw-tcp-hosts/d')
                    rule=$(sed -n '/\[Rule\]/,/^\[/p' "$conf_file" | sed '/^\[/d; /^[[:space:]]*$/d; /^#/d')
                    [ -z "$rule" ] && rule=$(sed -n '/\[Rule\]/,/^\[/p' "$download_file" | sed '/^\[/d; /^[[:space:]]*$/d; /^#/d')
                    host=$(sed -n '/\[Host\]/,/^\[/p' "$conf_file" | sed '/^\[/d; /^[[:space:]]*$/d; /^#/d')
                    [ -z "$host" ] && host=$(sed -n '/\[Host\]/,/^\[/p' "$download_file" | sed '/^\[/d; /^[[:space:]]*$/d; /^#/d')
                    reject=$(echo "$script" | awk '/ reject/ {print}' | sed 's/url reject/reject/g')
                
                    [ -n "$reject" ] && [ -n "$rewrite" ] && rewrite=$(printf "%s\n%s" "$rewrite" "$reject") ; script=$(echo "$script" | sed '/ reject/d')
                    [ -n "$reject" ] && [ -z "$rewrite" ] && rewrite="$reject" ; script=$(echo "$script" | sed '/ reject/d')
                    [ -n "$general" ] && echo -e "\n[General]\n$general" >> "$plugin_file"
                    [ -n "$rewrite" ] && echo -e "\n[Rewrite]\n$rewrite" >> "$plugin_file"
                    [ -n "$host" ] && echo -e "\n[Host]\n$host" >> "$plugin_file"
                    [ -n "$rule" ] && echo -e "\n[Rule]\n$rule" >> "$plugin_file"
                    [ -n "$script" ] && echo -e "\n[Script]\n$script" >> "$plugin_file"
                    [ -n "$mitm" ] && echo -e "\n[Mitm]\nhostname = $mitm" >> "$plugin_file"
                
                    # http-response
                    sed -i '/script-response-body/ s/^/http-response /' "$plugin_file"
                    sed -i '/script-response-body/ s/$/, requires-body = true, tag =/' "$plugin_file"
                    sed -i 's/url script-response-body/script-path =/' "$plugin_file"

                    # http-request
                    sed -i '/script-request-\(header\|body\)/ s/^/http-request /' "$plugin_file"
                    sed -i '/script-request-header/ s/$/, tag =/' "$plugin_file"
                    sed -i '/script-request-body/ s/$/, requires-body = true, tag =/' "$plugin_file"
                    sed -i 's/url script-request-\(header\|body\)/script-path =/' "$plugin_file"

                    #tag=
                    for keyword in 'http-response' 'http-request'; do
                        line_numbers=$(grep -n "$keyword" "$plugin_file" | cut -d: -f1)
                        for line_number in $line_numbers; do
                            if [ "$line_number" ]; then
                                current_line=$(sed -n "${line_number}p" "$plugin_file")
                                if [[ "$current_line" =~ [=]$ || "$current_line" =~ [=][[:space:]]$ ]]; then
                                    previous_line_number=$((line_number - 1))
                                    previous_line=$(sed -n "${previous_line_number}p" "$plugin_file")
                                    if [[ "$previous_line" == "#"* ]]; then
                                        comment_value=$(echo "$previous_line" | sed 's/^# *//; s/^> *//')
                                        sed -i -e "${line_number}s/$/ $comment_value/" "$plugin_file"
                                    else
                                        name_value=$(echo "$previous_line" | grep -o 'tag = [^ ]*' | sed 's/tag = //')
                                        [ -z "$name_value" ] && name_value=$name
                                        sed -i -e "${line_number}s/$/ $name_value/" "$plugin_file"
                                    fi
                                fi
                            fi
                        done
                    done
                    sed -i '/^# /d' "$plugin_file"

                    # scriptä¸‹è½½
                    mkdir -p "tmp/$script_folder/$script_name/script" "$script_folder/$script_name/script"
                    while IFS= read -r line; do
                      if [[ "$line" == *"script-path"* ]]; then
                        script_download_url=$(echo "$line" | sed -n 's/^.*script-path\s*=\s*\([^,]*\).*$/\1/p')
                        script_basename=$(basename "$script_download_url" | awk '{print tolower($0)}')
                        script_tmp_path="tmp/$script_folder/$script_name/script/$script_basename"
                        script_folder_path="$script_folder/$script_name/script/$script_basename"
                        wget -O "$script_tmp_path" "$script_download_url" --tries=2
                        if head -n 5 "$script_tmp_path" | awk '/æ¥æº|å¼•ç”¨/ && /http/ {exit 1}'; then
                            sed -i '1i\/*\nè„šæœ¬å¼•ç”¨'"$script_download_url"'\n*/' "$script_tmp_path"
                        fi
                        # å¯¹æ¯”scriptå†…å®¹æ›´æ–°dateå€¼
                        if [ -f "$script_tmp_path" ] && [ -f "$script_folder_path" ]; then
                            if ! cmp -s "$script_tmp_path" "$script_folder_path"; then
                                sed -i "s/#!date.*/#!date = $current_date/" "$plugin_file"
                                grep -q '^#!date' "$conf_file" && sed -i "s/^#!date.*/#!date = $current_date/" "$conf_file" || echo -e "\n#!date = $current_date" >> "$conf_file"
                            fi
                        fi
                        full_url="$base_url$script_folder_path"
                        sed -i "s#$(echo "$script_download_url" | sed 's/[&/\]/\\&/g')#$full_url#" "$plugin_file"
                        mv -f "$script_tmp_path" "$script_folder_path"
                      fi
                    done < "$plugin_file"

                    # è§„èŒƒæ–‡ä»¶æ ¼å¼
                    #sed -i '1,/^#!date/{/^$/d}' $conf_file
                    #sed -i 's/\([^[:space:]]\)\s*=\s*\([^[:space:]]\)/\1 = \2/g' $plugin_file
                    #sed -i -E '/( script-path| requires-body| tag| timeout)\s*=/ s/([^[:space:]])\s*=\s*([^[:space:]])/\1 = \2/g' $plugin_file
                    sed -i '/^hostname/s/,\([^ ]\)/, \1/g' $plugin_file
                    
                    # å¯¹æ¯”æ’ä»¶å†…å®¹æ›´æ–°dateå€¼
                    grep -v '^#!date' "$plugin_file" > "plugin_new.tmp"
                    if [ -f "$loon_plugin_folder/$script_name.plugin" ]; then
                        grep -v '^#!date' "$loon_plugin_folder/$script_name.plugin" > "plugin_old.tmp"
                    fi
                    if [ -f "plugin_new.tmp" ] && [ -f "plugin_old.tmp" ]; then
                        if ! cmp -s "plugin_new.tmp" "plugin_old.tmp"; then
                            sed -i "s/#!date.*/#!date = $current_date/" "$plugin_file"
                            grep -q '^#!date' "$conf_file" && sed -i "s/^#!date.*/#!date = $current_date/" "$conf_file" || echo -e "\n#!date = $current_date" >> "$conf_file"
                        fi
                    fi
                    rm -f "plugin_new.tmp" "plugin_old.tmp"
                    mv -f "$plugin_file" "$loon_plugin_folder/"
                    
                    #å®ä¾‹ç”Ÿæˆconf
                    script_file="$script_folder/$script_name/$script_name.conf"
                    [ ! -e "$script_file" ] && mkdir -p "$script_folder/$script_name" && mv "$conf_file" "$script_file"
                fi
                rm -fr tmp
            fi
        done
            
        if [ -n "$(find "$loon_plugin_folder" -name '*.plugin' | head -n 1)" ]; then
            echo 'å¼€å§‹æ›´æ–°readme.md'
            process_plugin_file() {
                local file="$1"
                plugin_name=$(extract_value "^#!name" "$file")
                plugin_date=$(grep -i "^#!date" "$file" | awk -F '=' '{print $2}' | sed 's/^ *//;s/ *$//' | while read date; do date -d "$date" +%Y/%m/%d; done)
                if [ -n "$plugin_name" ]; then
                    install_link="https://www.nsloon.com/openloon/import?plugin=$base_url$file"
                    raw_link="$base_url$file"
                    echo "| âœ…[$plugin_name]($raw_link) | $plugin_date | [å¯¼å…¥]($install_link) |" >> "$readme_file"
                fi
            }
            files_with_dates=$(find "$loon_plugin_folder" -maxdepth 1 -type f -name "*.plugin" -exec grep -H '#!date' {} +)
            plugin_files=($(echo "$files_with_dates" | awk -F'[=]' '{print $NF,$0}' | sort -r -k1 | cut -d' ' -f4- | awk -F ':' '{print $1}'))
            readme_file="$loon_plugin_folder/readme.md"
            touch "$readme_file" && echo -e "## ğŸˆLoonæ’ä»¶\n| âš™æ’ä»¶åç§° | ğŸ“Œæ›´æ–°æ—¶é—´ | é“¾æ¥ |\n| - | - | - |" > "$readme_file"
            for file in "${plugin_files[@]}"; do
                file_base_name=$(basename "$file" .plugin)
                conf_file="$script_folder/$file_base_name/$file_base_name.conf"
                if [ -f "$conf_file" ] && grep -qE "^readme_tag\s*=\s*(å¸¸ç”¨æ’ä»¶|)$" "$conf_file"; then
                    process_plugin_file "$file"
                fi
            done
            echo -e "#### ğŸ”“è§£é”æ’ä»¶:\n<details>\n<summary>ğŸ‘†ï¸ç‚¹å‡»æŸ¥çœ‹</summary>\n<ul>\n\n| ğŸ”“æ’ä»¶åç§° | ğŸ“Œæ›´æ–°æ—¶é—´ | é“¾æ¥ |\n| - | - | - |" >> "$readme_file"
            for file in "${plugin_files[@]}"; do
                file_base_name=$(basename "$file" .plugin)
                conf_file="$script_folder/$file_base_name/$file_base_name.conf"
                if [ -f "$conf_file" ] && grep -qE "^readme_tag\s*=\s*.*è§£é”.*$" "$conf_file"; then
                    process_plugin_file "$file"
                fi
            done
            echo -e "</ul>\n</details>\n\n## âš ï¸å…è´£å£°æ˜" >> "$readme_file"
            sed -n '/^## âš ï¸å…è´£å£°æ˜$/,/^##/{/^##/!p}' readme.md >> "$readme_file"
            sed -i '/## ğŸˆLoonæ’ä»¶/,$d' loon/readme.md ; cat $readme_file >> loon/readme.md
        fi
        
        if [ ! -f "$script_folder/script.conf" ]; then
            echo 'åˆ›å»ºscriptç¤ºä¾‹'
            cat <<EOF > "$script_folder/script.conf"
        ## ç”¨äº Loon æ’ä»¶å®šæ—¶ä¸‹è½½åˆ°ä»“åº“ï¼Œä»¥é˜²æ­¢åŸä½œè€…åˆ é™¤åº“çš„è„šæœ¬é…ç½®æ–‡ä»¶ã€‚
        # æ”¯æŒå°† Quantumult X è„šæœ¬è½¬æ¢ä¸º Loon æ’ä»¶ï¼Œå¹¶è¦†ç›–åŸæ’ä»¶ä¸­çš„å‚æ•°ã€‚
        # æ³¨æ„ï¼šä»…ä¾›å­¦ä¹ è‡ªç”¨ï¼Œä¸ä¿è¯ä½¿ç”¨è¿‡ç¨‹ä¸­çš„é—®é¢˜ã€‚
        
        # ä¸‹è½½åœ°å€ï¼Œæ”¯æŒ Loon æ’ä»¶å’Œ Quantumult X è„šæœ¬ï¼ˆå¿…å¡«ï¼‰
        remote_url = 
        
        # ç”¨äºåˆ›å»ºçš„æ–‡ä»¶åï¼ˆå¯é€‰ï¼Œé»˜è®¤ä½¿ç”¨ä¸‹è½½åœ°å€çš„æ–‡ä»¶åï¼‰
        script_name = 
        
        # ç”¨äº readme.md ä¸­æ’ä»¶åˆ†ç±»ï¼ˆå¯é€‰ï¼‰
        readme_tag = 
        
        # ä½¿ç”¨æ–¹æ³•ï¼š
        # 1. å¡«å†™ä¸‹è½½åœ°å€ï¼ˆremote_urlï¼‰å’Œå¯é€‰çš„æ–‡ä»¶åï¼ˆscript_nameï¼‰ã€‚
        # 2. å¿…è¦æ—¶å¡«å†™æ’ä»¶åˆ†ç±»æ ‡ç­¾ï¼ˆreadme_tagï¼‰ã€‚
        # 3. åœ¨ä¸‹æ–¹éœ€è¦è¦†ç›–é»˜è®¤å‚æ•°çš„éƒ¨åˆ†æ·»åŠ ç›¸åº”çš„é…ç½®ã€‚
        # 4. ä¿å­˜è¯¥æ–‡ä»¶ä¼šè‡ªåŠ¨è¿è¡Œå·¥ä½œæµï¼Œç”Ÿæˆæ’ä»¶å’Œ conf é…ç½®æ–‡ä»¶ï¼Œä¾¿äºåç»­ä¿®æ”¹ã€‚
        
        # ============================= å¯é€‰ - ä¸‹æ–¹æ·»åŠ éœ€è¦è¦†ç›–çš„é»˜è®¤å‚æ•° =============================
        # ä¾‹å¦‚ï¼š
        # #!name = xxx
        # #!icon = xxx
        # [Rule]
        # DOMAIN, xxx, PROXY
        # [Mitm]
        # hostname = xxx
        EOF
        fi
        
    - name: Commit and push
      run: |
        git config --global user.email "mphin@qq.com" && git config --global user.name "Bot"
        git add . && git commit -m "æ’ä»¶æ›´æ–°$(date +'%Y-%m-%d %H:%M')" || exit 0
        git push

    - name: Cleanup Workflow
      uses: Mattraks/delete-workflow-runs@main
      with:
        retain_days: 1
        keep_minimum_runs: 2